<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CamZip</title>
<link rel="manifest" href="manifest.json" />
<style>
  :root{--ios-blue:#007AFF;--bg:#ffffff;--muted:#666;}
  body{margin:0;font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;background:var(--bg);color:#111}
  header{background:var(--ios-blue);color:white;padding:14px 16px;font-size:18px;text-align:center}
  main{padding:16px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  button{background:var(--ios-blue);color:white;border:none;padding:10px 14px;border-radius:12px;font-size:15px}
  button.ghost{background:transparent;color:var(--ios-blue);border:1px solid var(--ios-blue)}
  #video{width:100%;max-width:700px;background:#000;border-radius:8px}
  #preview{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px}
  .thumb{position:relative;width:110px;height:78px;border:1px solid #ddd;border-radius:6px;overflow:hidden;background:#f5f5f5}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .thumb .actions{position:absolute;left:4px;top:4px;display:flex;gap:4px}
  .smallbtn{background:rgba(255,255,255,0.9);color:#333;padding:4px 6px;border-radius:6px;border:0;font-size:12px}
  #session-name{width:calc(100% - 32px);max-width:520px;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;margin:0 auto;display:block}
  .hidden{display:none}
  #save-files{background:var(--ios-blue);padding:12px 18px;border-radius:12px;font-size:16px;margin-top:12px}
  footer{padding:16px;text-align:center;color:var(--muted);font-size:13px}
  @media (min-width:600px){ .controls{justify-content:center} }
</style>
</head>
<body>
<header>CamZip</header>
<main>
  <div style="text-align:center;margin-bottom:8px">
    <input id="session-name" type="text" placeholder="Session name" />
  </div>
  <div class="controls">
    <button id="start">Start Session</button>
    <button id="take" class="hidden">Take Photo</button>
    <button id="download" class="hidden">Create ZIP</button>
    <button id="cancel" class="ghost hidden">End Session</button>
  </div>

  <div id="camera-area" style="text-align:center">
    <video id="video" autoplay playsinline class="hidden"></video>
    <canvas id="canvas" class="hidden"></canvas>
  </div>

  <div id="preview" aria-live="polite"></div>

  <div style="text-align:center">
    <button id="save-files" class="hidden">Save to Files</button>
  </div>
</main>
<footer>CamZip — session ZIPs with date</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script>
const iosBlue = '#007AFF';
const startBtn = document.getElementById('start');
const takeBtn = document.getElementById('take');
const downloadBtn = document.getElementById('download');
const cancelBtn = document.getElementById('cancel');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const preview = document.getElementById('preview');
const saveFilesBtn = document.getElementById('save-files');
const sessionInput = document.getElementById('session-name');

let stream = null;
let photos = []; // {dataUrl}
let sessionActive = false;

// Helper: get today's date YYYY-MM-DD
function todayDate(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

// Prefill session input with leading date and place caret at start
function prefillSession(){
  const date = todayDate();
  sessionInput.value = " " + date;
  sessionInput.focus();
  // place caret at front so typed text goes before date
  sessionInput.setSelectionRange(0,0);
}

// Build preview thumbnail element
function createThumb(dataUrl, index){
  const div = document.createElement('div');
  div.className = 'thumb';
  const img = document.createElement('img');
  img.src = dataUrl;
  div.appendChild(img);

  const actions = document.createElement('div');
  actions.className = 'actions';
  const retake = document.createElement('button');
  retake.className = 'smallbtn';
  retake.textContent = 'Retake';
  retake.onclick = () => retakePhoto(index);
  const del = document.createElement('button');
  del.className = 'smallbtn';
  del.textContent = 'Delete';
  del.onclick = () => deletePhoto(index);
  actions.appendChild(retake);
  actions.appendChild(del);
  div.appendChild(actions);
  return div;
}

function refreshPreview(){
  preview.innerHTML = '';
  photos.forEach((p, i) => {
    const thumb = createThumb(p.dataUrl, i);
    preview.appendChild(thumb);
  });
}

// Start camera stream
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
    video.srcObject = stream;
    video.classList.remove('hidden');
  }catch(err){
    alert('Camera access denied or not available: ' + err);
  }
}

// Stop camera stream
function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  video.classList.add('hidden');
}

// Capture photo into photos array at next index
function capturePhoto(replaceIndex = null){
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
  if(replaceIndex === null){
    photos.push({ dataUrl });
  } else {
    photos[replaceIndex] = { dataUrl };
  }
  refreshPreview();
}

// Retake: open camera and capture to replace index
let pendingRetakeIndex = null;
function retakePhoto(index){
  pendingRetakeIndex = index;
  // open camera and allow user to take one shot which will replace
  startCamera().then(()=> {
    takeBtn.classList.remove('hidden');
    takeBtn.textContent = 'Capture Retake';
  });
}

// Delete photo
function deletePhoto(index){
  photos.splice(index,1);
  refreshPreview();
  if(photos.length === 0){
    saveFilesBtn.classList.add('hidden');
    downloadBtn.classList.remove('hidden');
  }
}

// Wire up buttons
startBtn.addEventListener('click', async ()=>{
  if(sessionActive){
    return;
  }
  prefillSession();
  sessionActive = true;
  photos = [];
  refreshPreview();
  startBtn.classList.add('hidden');
  takeBtn.classList.remove('hidden');
  downloadBtn.classList.remove('hidden');
  cancelBtn.classList.remove('hidden');
  // auto-open camera immediately
  await startCamera();
});

takeBtn.addEventListener('click', ()=>{
  // capture either as new or replace
  if(pendingRetakeIndex !== null){
    capturePhoto(pendingRetakeIndex);
    pendingRetakeIndex = null;
    takeBtn.textContent = 'Take Photo';
    stopCamera();
  } else {
    capturePhoto();
  }
  // after a capture, show save button
  if(photos.length > 0){
    saveFilesBtn.classList.remove('hidden');
  }
});

cancelBtn.addEventListener('click', ()=>{
  // end session, stop camera, reset
  stopCamera();
  sessionActive = false;
  photos = [];
  refreshPreview();
  startBtn.classList.remove('hidden');
  takeBtn.classList.add('hidden');
  downloadBtn.classList.add('hidden');
  cancelBtn.classList.add('hidden');
  saveFilesBtn.classList.add('hidden');
});

downloadBtn.addEventListener('click', async ()=>{
  if(photos.length === 0){
    alert('No photos to zip');
    return;
  }
  // finalize session name: if user typed prefix before date, combine
  const sessionRaw = sessionInput.value.trim();
  let folderName = sessionRaw;
  if(!folderName) folderName = todayDate();
  // Ensure filenames are numbered in order
  const zip = new JSZip();
  const imgFolder = zip.folder(folderName);
  photos.forEach((p, idx) => {
    const base64 = p.dataUrl.split(',')[1];
    imgFolder.file(`${idx+1}.jpg`, base64, { base64: true });
  });
  const blob = await zip.generateAsync({ type:'blob' });
  // create download object URL and show Save to Files button
  window._lastZipBlob = blob;
  window._lastZipName = folderName + '.zip';
  alert('ZIP ready — tap Save to Files to store it on your device');
  saveFilesBtn.classList.remove('hidden');
  // also offer immediate download link for desktop
  // we keep downloadBtn visible so user can create again if needed
});

// Save to Files button handler - try navigator.share with File if available, else download anchor
saveFilesBtn.addEventListener('click', async ()=>{
  const blob = window._lastZipBlob;
  const name = window._lastZipName || ('CamZip-' + todayDate() + '.zip');
  if(!blob){
    alert('No ZIP available. Create ZIP first.');
    return;
  }
  // Try Web Share API with files (mobile)
  try{
    if(navigator.canShare && navigator.canShare({ files: [new File([blob], name, { type: 'application/zip' })] })){
      const file = new File([blob], name, { type: 'application/zip' });
      await navigator.share({ files: [file], title: name });
      return;
    }
  }catch(e){
    // ignore and fallback
    console.log('Web Share failed', e);
  }
  // Fallback: create object URL and trigger download (Safari will show download UI)
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
});

// Auto-place caret at start if user focuses session input and it's prefilled
sessionInput.addEventListener('focus', ()=>{
  // if value ends with today's date and caret not set, set to start
  const date = todayDate();
  if(sessionInput.value.endsWith(date)){
    sessionInput.setSelectionRange(0,0);
  }
});

// On page load, prefill session input with date so user can type prefix
window.addEventListener('load', ()=>{
  const date = todayDate();
  sessionInput.value = " " + date;
  sessionInput.setSelectionRange(0,0);
});

// Register service worker if supported
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW registered')).catch(()=>{});
}
</script>
</body>
</html>
